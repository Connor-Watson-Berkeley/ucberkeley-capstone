# Grid Search Parameter Optimization - Quick Reference

**Status:** ✅ Framework Complete - Ready to Run
**Created:** 2025-11-10
**Location:** `trading_agent/`

---

## What This Does

Automatically tests 100s-1000s of parameter combinations to find values that maximize net revenue for each trading strategy. Ensures matched pairs (baseline/predictive) share the same parameters.

---

## Quick Start

### 1. Run Grid Search

```python
# In Databricks: commodity_prediction_analysis/parameter_grid_search_notebook.py

# Configure
CURRENT_COMMODITY = 'coffee'
CURRENT_MODEL = 'sarimax_auto_weather_v1'
USE_FINE_GRAIN_GRID = False  # Start with coarse

# Run all cells
# Output: /dbfs/FileStore/optimal_parameters.json
```

### 2. Review Results

Check console output for optimal parameters and net revenue improvements.

### 3. Update Notebook

Copy optimal values to `trading_prediction_analysis_multi_model.py` lines 66-98.

---

## Files Created

### Core Implementation
- **`parameter_grid_search.py`** - Standalone Python script
- **`commodity_prediction_analysis/parameter_grid_search_notebook.py`** - Databricks notebook (USE THIS)
- **`parameter_config.py`** - Utilities for loading optimal parameters
- **`optional_load_optimal_parameters_cell.py`** - Integration code for main notebook

### Configuration & Templates
- **`optimal_parameters_template.json`** - Template showing expected structure
- **Output: `optimal_parameters.json`** - Best parameters (generated by grid search)
- **Output: `grid_search_results_all.csv`** - All tested combinations (generated by grid search)

### Documentation
- **`docs/PARAMETER_GRID_SEARCH_GUIDE.md`** - Comprehensive 450+ line guide
- **`GRID_SEARCH_README.md`** - This quick reference

---

## Key Features

✅ **553 total parameter combinations** tested (coarse grid)
✅ **Maximizes net revenue** as objective function
✅ **Matched pair enforcement** - baseline/predictive pairs share parameters
✅ **Two-stage optimization** - coarse → fine-grained
✅ **Automatic results** - JSON + CSV output
✅ **Parameter visualization** - Charts showing impact on performance

---

## Strategies Optimized

| Strategy | Parameters | Combinations |
|----------|-----------|--------------|
| ImmediateSale | min_batch_size, sale_frequency_days | 16 |
| EqualBatch | batch_size, frequency_days | 25 |
| PriceThreshold | threshold_pct, batch_fraction, max_days_without_sale | 80 |
| MovingAverage | ma_period, batch_fraction, max_days_without_sale | 80 |
| Consensus | consensus_threshold, min_return, evaluation_day | 60 |
| ExpectedValue | min_ev_improvement, baseline_batch, baseline_frequency | 100 |
| RiskAdjusted | min_return, max_uncertainty, consensus_threshold, evaluation_day | 192 |

**Total:** 553 combinations (coarse grid) | ~100 combinations (fine grid per strategy)

---

## Matched Pairs Constraint

**PriceThresholdStrategy ↔ PriceThresholdPredictive**
- Share: `threshold_pct`, `batch_fraction`, `max_days_without_sale`
- Differ only in: prediction usage and cost-benefit analysis

**MovingAverageStrategy ↔ MovingAveragePredictive**
- Share: `ma_period`, `batch_fraction`, `max_days_without_sale`
- Differ only in: prediction usage and cost-benefit analysis

This ensures apples-to-apples comparison - the only difference should be prediction usage.

---

## Output Files

### optimal_parameters.json
```json
{
  "generated_at": "2025-11-10T12:00:00",
  "commodity": "coffee",
  "model": "sarimax_auto_weather_v1",
  "parameters": {
    "price_threshold": {
      "params": {
        "threshold_pct": 0.05,
        "batch_fraction": 0.30,
        "max_days_without_sale": 60
      },
      "net_revenue": 14823.45,
      "metrics": {...}
    },
    ...
  }
}
```

### grid_search_results_all.csv
All tested combinations sorted by net revenue. Useful for sensitivity analysis.

---

## Two-Stage Optimization

### Stage 1: Coarse Search
- **Purpose:** Identify promising ranges
- **Grid:** Wide ranges, large steps
- **Runtime:** 30-60 minutes
- **Use:** `USE_FINE_GRAIN_GRID = False`

### Stage 2: Fine-Grained Search
- **Purpose:** Fine-tune around optimal
- **Grid:** Narrow ranges, small steps
- **Runtime:** 20-40 minutes
- **Use:** `USE_FINE_GRAIN_GRID = True`

---

## Validation Workflow

1. **Run Grid Search** → Get `optimal_parameters.json`
2. **Review Parameters** → Check if values make sense
3. **Update Notebook** → Copy to BASELINE_PARAMS / PREDICTION_PARAMS
4. **Run Full Backtest** → Validate performance
5. **Statistical Test** → Bootstrap CI, t-tests, p-values
6. **Deploy** → If validated, deploy to production

---

## Example Usage

### Load and Apply Optimal Parameters

```python
from parameter_config import load_optimal_parameters, print_update_instructions

# Load optimal parameters
optimal = load_optimal_parameters('/dbfs/FileStore/optimal_parameters.json')

# Print update instructions
print_update_instructions(optimal)

# Output shows exactly what to copy to notebook
```

### Run for Specific Strategies Only

```python
# In parameter_grid_search_notebook.py
STRATEGIES_TO_OPTIMIZE = ['price_threshold', 'moving_average', 'consensus']
```

### Sample Large Grids

```python
# Test only 100 random combinations per strategy
MAX_COMBINATIONS_PER_STRATEGY = 100
```

---

## Expected Improvements

Based on typical parameter optimization:
- **10-20% improvement** in net revenue vs. current semi-arbitrary parameters
- **More consistent performance** across different market conditions
- **Better matched pair comparisons** (ensure only prediction usage differs)

---

## Troubleshooting

### Grid search takes too long
- Set `MAX_COMBINATIONS_PER_STRATEGY = 100` to sample
- Optimize fewer strategies with `STRATEGIES_TO_OPTIMIZE`
- Use coarser grid (reduce values per parameter)

### Optimal parameters at grid boundaries
- Expand grid range in that direction
- Example: If best `threshold_pct = 0.10` (max tested), try `[0.08, 0.10, 0.12, 0.15, 0.20]`

### Results don't match expected behavior
- Verify data loaded correctly
- Check commodity config
- Run single backtest with debug output

---

## Next Steps

1. **Run Grid Search:** Execute `parameter_grid_search_notebook.py` in Databricks
2. **Review Results:** Check optimal parameters and net revenue
3. **Validate:** Run full backtest with optimal params
4. **Update Production:** Copy optimal values to main notebook
5. **Monitor:** Track actual performance vs. expected
6. **Re-optimize:** Quarterly or when market conditions change

---

## Support

- **Full Documentation:** [`docs/PARAMETER_GRID_SEARCH_GUIDE.md`](docs/PARAMETER_GRID_SEARCH_GUIDE.md)
- **Parameter Utilities:** [`parameter_config.py`](parameter_config.py)
- **Integration Help:** [`optional_load_optimal_parameters_cell.py`](commodity_prediction_analysis/optional_load_optimal_parameters_cell.py)

---

## File Locations

```
trading_agent/
├── parameter_grid_search.py                 # Standalone script
├── parameter_config.py                       # Loading utilities
├── optimal_parameters_template.json          # Template
├── GRID_SEARCH_README.md                     # This file
│
├── commodity_prediction_analysis/
│   ├── parameter_grid_search_notebook.py    # Main grid search notebook
│   └── optional_load_optimal_parameters_cell.py  # Integration code
│
└── docs/
    ├── PARAMETER_GRID_SEARCH_GUIDE.md        # Comprehensive guide
    └── README.md                              # Docs index
```

---

Last Updated: 2025-11-10
