# Trading Agent - Production System

**Status:** ✅ Phase 2 Core Complete (Automation ready for periodic backtesting)
**Last Updated:** 2025-11-24

---

## System Overview

This production system provides **TWO DISTINCT WORKFLOWS**:

### 1. Periodic Backtesting (Monthly/Quarterly)
**Purpose:** Evaluate strategy performance and identify best approaches
**Frequency:** Periodic (monthly, quarterly)
**Orchestrator:** `run_backtest_workflow.py`

### 2. Daily Operations (Every Day)
**Purpose:** Generate trading recommendations using best strategy
**Frequency:** Daily
**Script:** `../operations/daily_recommendations.py` (already exists)

---

## Quick Start

### Periodic Backtesting

```bash
cd /Users/markgibbons/capstone/ucberkeley-capstone/trading_agent/commodity_prediction_analysis

# Full workflow - all commodities
python production/run_backtest_workflow.py --mode full

# Single commodity
python production/run_backtest_workflow.py --mode full --commodity coffee

# Use existing predictions (skip loading)
python production/run_backtest_workflow.py --mode backtest-only
```

### Daily Recommendations

```bash
cd /Users/markgibbons/capstone/ucberkeley-capstone/trading_agent

# Single commodity, single model
python operations/daily_recommendations.py --commodity coffee --model sarimax_auto_weather_v1

# All available models
python operations/daily_recommendations.py --commodity coffee --all-models

# Output JSON for WhatsApp integration
python operations/daily_recommendations.py --commodity coffee --model sarimax_auto_weather_v1 --output-json recommendations.json
```

---

## Production Components

### Scripts (production/scripts/)

| Script | Purpose | Frequency | Status |
|--------|---------|-----------|--------|
| `generate_synthetic_predictions.py` | Generate synthetic predictions for testing | One-time / Testing | ✅ Complete |
| `load_forecast_predictions.py` | Load latest real forecasts from table | Periodic | ✅ Complete |

**Note:** Notebooks 06-10 (statistical validation, feature importance, etc.) use OLD approach (paired t-tests). NEW approach uses theoretical maximum benchmark. Modern analysis suite to be designed.

### Runners (production/runners/)

Modular backtest execution framework (replicates notebook 05 functionality):

| Module | Purpose | Lines | Status |
|--------|---------|-------|--------|
| `data_loader.py` | Load prices and predictions | 250 | ✅ Complete |
| `strategy_runner.py` | Execute strategy backtests | 350 | ✅ Complete |
| `visualization.py` | Generate performance charts | 400 | ✅ Complete |
| `result_saver.py` | Save to Delta + pickle | 200 | ✅ Complete |
| `multi_commodity_runner.py` | Orchestrate all combinations | 246 | ✅ Complete |

**Total:** 5 modules, 1,446 lines of production code

### Strategies (production/strategies/)

9 trading strategies extracted from diagnostics:

**Baseline (4):**
1. Immediate Sale - Weekly liquidation
2. Equal Batches - Fixed 25% every 30 days
3. Price Threshold - Sell when price > MA + threshold
4. Moving Average - Sell on MA crossover

**Prediction-Based (5):**
5. Consensus - Sell based on 70%+ bullish paths
6. Expected Value - Optimize timing via EV
7. Risk-Adjusted - Balance return vs uncertainty
8. Price Threshold Predictive - Baseline #3 + predictions
9. Moving Average Predictive - Baseline #4 + predictions

**Total:** 4 modules, 1,900 lines

### Configuration (production/config/)

- `production_config.py` - Central configuration (commodity params, paths, strategy params)

### Core Engine (production/core/)

- `backtest_engine.py` - Harvest-aware backtesting with cost modeling

### Tests (production/runners/tests/)

**Comprehensive test suite:**
- 6 test files, ~2,500 lines
- 93%+ expected coverage
- Unit tests (80%), integration tests (15%), smoke tests (5%)

See `production/runners/tests/README.md` for details.

---

## Workflows

### Workflow 1: Periodic Backtesting

**When to Run:** Monthly or quarterly to re-evaluate strategies

**What It Does:**
1. Loads latest forecast predictions from `commodity.forecast.distributions`
2. Runs backtests for all 9 strategies across all commodity-model combinations
3. Generates performance metrics (net earnings, Sharpe ratio, trades, etc.)
4. Identifies best strategy for each commodity-model pair
5. Saves results to Delta tables and pickle files
6. Generates 220+ visualization charts

**Orchestrator:** `run_backtest_workflow.py`

**Usage:**

```bash
# Full workflow
python production/run_backtest_workflow.py --mode full

# Options:
#   --mode full                 Load predictions + run backtests
#   --mode backtest-only        Skip prediction loading, use existing data
#   --mode synthetic-test       Quick test with 100% accuracy synthetic
#   --commodity coffee          Process single commodity
#   --commodities coffee,sugar  Process multiple commodities
#   --include-theoretical-max   Add theoretical max analysis (slow)
```

**Outputs:**
- **Delta tables:** `commodity.trading_agent.results_{commodity}_{model_version}`
- **Pickle files:** `results_detailed_*.pkl`
- **Charts:** 220+ PNG files in `/Volumes/commodity/trading_agent/files/`
- **Best strategy selection:** Stored in workflow summary

**Duration:**
- Coffee only: ~10-15 minutes
- All commodities: ~30-45 minutes

---

### Workflow 2: Daily Operations

**When to Run:** DAILY when new forecasts are available

**What It Does:**
1. Loads today's forecast for specified model
2. Loads current state (inventory, price, history)
3. Runs all 9 strategies to generate recommendations
4. Shows SELL/HOLD decision with quantity and reasoning
5. Optionally outputs JSON for WhatsApp integration

**Script:** `../operations/daily_recommendations.py` (already exists)

**Usage:**

```bash
# Get recommendations for specific model
python operations/daily_recommendations.py \
  --commodity coffee \
  --model sarimax_auto_weather_v1

# Try all available models
python operations/daily_recommendations.py \
  --commodity coffee \
  --all-models

# Generate JSON for WhatsApp
python operations/daily_recommendations.py \
  --commodity coffee \
  --model sarimax_auto_weather_v1 \
  --output-json recommendations.json
```

**Outputs:**
- Console display of recommendations
- Optional JSON file for messaging integration
- Multi-currency support (COP, VND, BRL, INR, etc.)

**Duration:** < 1 minute

**Integration:** See `../operations/README.md` for WhatsApp integration guide

---

## Architecture

### Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                       FORECAST AGENT                                │
│  commodity.forecast.distributions (Monte Carlo forecast paths)     │
└────────────────────────┬────────────────────────────────────────────┘
                         │
                         ├──────────────────┬──────────────────────────┐
                         │                  │                          │
                         ▼                  ▼                          ▼
            ┌─────────────────────┐  ┌──────────────┐  ┌───────────────────────┐
            │  PERIODIC BACKTEST  │  │ THEORETICAL  │  │   DAILY OPERATIONS    │
            │     (monthly)       │  │  MAX BENCH   │  │       (daily)         │
            └──────────┬──────────┘  │  (periodic)  │  └──────────┬────────────┘
                       │             └──────────────┘              │
                       ▼                                           ▼
         ┌──────────────────────────┐               ┌──────────────────────────┐
         │ run_backtest_workflow.py │               │ daily_recommendations.py │
         └──────────┬───────────────┘               └──────────┬───────────────┘
                    │                                           │
    ┌───────────────┼───────────────┐                          ▼
    │               │               │              ┌──────────────────────────┐
    ▼               ▼               ▼              │ WhatsApp Delivery        │
run_02_       multi_commodity  Identify           │ (Twilio Lambda)          │
forecast_     _runner          best               └──────────────────────────┘
predictions                    strategies
    │               │
    │               ▼
    │    ┌──────────────────────┐
    │    │  Production Runners  │
    │    ├──────────────────────┤
    │    │ • DataLoader         │
    │    │ • StrategyRunner     │
    │    │ • Visualization      │
    │    │ • ResultSaver        │
    │    └──────────────────────┘
    │               │
    └───────────────┴────────────────────────────┐
                                                  ▼
                    ┌───────────────────────────────────────┐
                    │         STORAGE                       │
                    ├───────────────────────────────────────┤
                    │ • Delta Tables (metrics)              │
                    │ • Pickle Files (detailed results)     │
                    │ • PNG Charts (visualizations)         │
                    │ • Best Strategy Selection             │
                    └───────────────────────────────────────┘
```

### Component Interaction

**Periodic Backtesting:**
1. `run_backtest_workflow.py` (orchestrator)
   - Calls `scripts/load_forecast_predictions.py` → Loads predictions
   - Calls `multi_commodity_runner` → Runs backtests
   - Identifies best strategies
   - Stores results

2. `multi_commodity_runner` (execution)
   - Uses `DataLoader` → Load data
   - Uses `StrategyRunner` → Execute 9 strategies
   - Uses `Visualization` → Generate charts
   - Uses `ResultSaver` → Save outputs

**Daily Operations:**
1. `daily_recommendations.py` (standalone)
   - Loads today's forecast
   - Applies all strategies
   - Generates recommendations
   - Outputs to console or JSON

---

## Scheduling

### Periodic Backtesting Schedule

**Recommended:** Monthly (first Monday of each month)

**Databricks Job Configuration:**

```json
{
  "name": "Monthly Strategy Backtesting",
  "job_clusters": [{
    "job_cluster_key": "backtest_cluster",
    "new_cluster": {
      "spark_version": "13.3.x-scala2.12",
      "node_type_id": "i3.xlarge",
      "num_workers": 2
    }
  }],
  "python_wheel_task": {
    "package_name": "trading_agent",
    "entry_point": "run_backtest_workflow",
    "parameters": ["--mode", "full"]
  },
  "schedule": {
    "quartz_cron_expression": "0 0 2 1 * ?",
    "timezone_id": "America/New_York"
  },
  "timeout_seconds": 10800
}
```

### Daily Operations Schedule

**Recommended:** Daily at 7 AM (after forecast generation)

**Databricks Job Configuration:**

```json
{
  "name": "Daily Coffee Recommendations",
  "job_clusters": [{
    "job_cluster_key": "daily_cluster",
    "new_cluster": {
      "spark_version": "13.3.x-scala2.12",
      "node_type_id": "i3.xlarge",
      "num_workers": 1
    }
  }],
  "python_wheel_task": {
    "package_name": "trading_agent",
    "entry_point": "daily_recommendations",
    "parameters": ["--commodity", "coffee", "--all-models", "--output-json", "recommendations.json"]
  },
  "schedule": {
    "quartz_cron_expression": "0 0 7 * * ?",
    "timezone_id": "America/New_York"
  },
  "timeout_seconds": 600
}
```

---

## Testing

### Run Test Suite

```bash
cd /Users/markgibbons/capstone/ucberkeley-capstone/trading_agent/commodity_prediction_analysis

# All tests
pytest production/runners/tests/ -v

# With coverage
pytest production/runners/tests/ \
  --cov=production.runners \
  --cov-report=html \
  --cov-report=term

# Specific test file
pytest production/runners/tests/test_strategy_runner.py -v

# Integration tests only
pytest production/runners/tests/test_integration.py -v
```

**Expected:** 150+ tests pass in ~30 seconds

See `production/runners/tests/README.md` for details.

---

## Output Structure

### Delta Tables

```
commodity.trading_agent.results_{commodity}_{model_version}
  - strategy (string)
  - type (baseline|prediction)
  - net_earnings (double)
  - total_revenue (double)
  - total_costs (double)
  - avg_sale_price (double)
  - sharpe_ratio (double)
  - n_trades (int)
  - days_to_liquidate (int)
  - ...
```

### Pickle Files

```
/Volumes/commodity/trading_agent/files/
  results_detailed_{commodity}_{model_version}.pkl
    - Daily state DataFrames
    - Trade-by-trade logs
    - Complete audit trail
```

### Visualizations

```
/Volumes/commodity/trading_agent/files/
  cumulative_earnings_{commodity}_{model_version}.png
  inventory_timeline_{commodity}_{model_version}.png
  price_vs_sales_{commodity}_{model_version}.png
  strategy_heatmap_{commodity}_{model_version}.png
  ... (220+ charts total)
```

---

## Future Enhancements

### Phase 2b: Modern Analysis Suite

**Note:** Strategy analysis (theoretical max, efficiency ratios) is now in a separate `analysis/` directory.

**Separation of Concerns:**
- **`production/`** (This directory) = Operational strategy selection
- **`analysis/`** = Research and strategy tuning with theoretical max benchmarks
- **`diagnostics/`** = OLD approach (keep for reference)

See `../analysis/README.md` for the modern analysis suite.

### Phase 3: Strategy Selection Automation

Store and apply best strategy selections:

```python
# After periodic backtest
best_strategies = {
    'coffee_arima_v1': 'Risk-Adjusted',
    'coffee_sarimax_auto_weather_v1': 'Consensus',
    'sugar_prophet_v1': 'Expected Value'
}

# Save to configuration table
spark.createDataFrame(best_strategies).write.mode('overwrite') \
    .saveAsTable('commodity.trading_agent.active_strategies')

# Daily operations load active strategy
active_strategy = spark.table('commodity.trading_agent.active_strategies') \
    .filter(f"commodity = '{commodity}' AND model = '{model}'") \
    .select('strategy').first()[0]

# Apply only the active strategy for daily recommendations
```

### Phase 4: Performance Tracking

Track recommendation accuracy over time:

```python
# Log each daily recommendation
recommendation_history = {
    'date': today,
    'commodity': 'coffee',
    'model': 'sarimax_auto_weather_v1',
    'strategy': 'Consensus',
    'recommended_action': 'SELL',
    'recommended_quantity': 12.5,
    'actual_action': None,  # To be filled later
    'actual_quantity': None
}

# Periodically compare recommendations vs actuals
accuracy_metrics = calculate_recommendation_accuracy(history)
```

---

## Troubleshooting

### Common Issues

**1. Import errors**
```
ModuleNotFoundError: No module named 'production.runners'
```
**Solution:** Ensure you're in the correct directory and PYTHONPATH is set:
```bash
cd /Users/markgibbons/capstone/ucberkeley-capstone/trading_agent/commodity_prediction_analysis
export PYTHONPATH="${PYTHONPATH}:$(pwd)"
```

**2. Spark session failures**
```
Could not initialize Spark session
```
**Solution:** Check Databricks connection or run locally with:
```bash
pip install pyspark
```

**3. Missing prediction data**
```
No predictions found for coffee - arima_v1
```
**Solution:** Run `run_02_forecast_predictions.py` first or check that forecasts exist in `commodity.forecast.distributions`

**4. Test failures**
```
Tests failing in production/runners/tests/
```
**Solution:** Check `production/runners/tests/README.md` for debugging steps

---

## Related Documentation

- **Overall System:** `/Users/markgibbons/capstone/ucberkeley-capstone/trading_agent/MASTER_SYSTEM_PLAN.md`
- **Runners Module:** `production/runners/README.md`
- **Test Suite:** `production/runners/tests/README.md`
- **Daily Operations:** `../operations/README.md`
- **WhatsApp Integration:** `../whatsapp/README.md`
- **Theoretical Max Analysis:** `diagnostics/ALGORITHM_PERFORMANCE_ANALYSIS.md`

---

## Contact

**Module Owner:** Trading Agent Team
**Created:** 2025-11-24
**Last Updated:** 2025-11-24

For questions:
1. Review this README
2. Check MASTER_SYSTEM_PLAN.md for system-wide architecture
3. Review component-specific READMEs
