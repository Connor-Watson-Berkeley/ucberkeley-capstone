# Data Sources and Limitations

**Ground Truth Commodity Forecasting Platform**

This document describes all data sources, their coverage dates, known limitations, and appropriate usage for modeling.

---

## Table of Contents
- [Market Data (Coffee & Sugar Prices)](#market-data)
- [Weather Data (Historical Actuals)](#weather-data-historical)
- [Weather Forecasts (Forward-Looking)](#weather-forecasts)
- [VIX (Volatility Index)](#vix-data)
- [Macro Economic Indicators](#macro-data)
- [CFTC (Commitment of Traders)](#cftc-data)
- [GDELT (News Sentiment)](#gdelt-data)
- [Region Coordinates](#region-coordinates)

---

## Market Data (Coffee & Sugar Prices)
**Databricks Tables**: `commodity.bronze.market`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Commodities**: Coffee (KC), Sugar (SB)
- **Frequency**: Daily
- **Variables**: Open, High, Low, Close, Volume

### Source
- ICE Futures US via Yahoo Finance API
- Continuous contracts (front month)

### Limitations
⚠️ **None** - Full historical coverage

### Usage for Modeling
✅ **All models** - No date restrictions

### Quality Notes
- Data is adjusted for contract rollovers
- Weekends/holidays have no data (trading days only)
- Volume data may be incomplete for older dates

---

## Weather Data (Historical Actuals)
**Databricks Tables**: `commodity.bronze.weather`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Regions**: 67 coffee/sugar growing regions worldwide
- **Frequency**: Daily
- **Variables**: Temperature (min/max/mean), Precipitation, Humidity, Wind, Solar Radiation

### Source
- Open-Meteo Historical Weather API
- Based on ERA5 reanalysis data from ECMWF

### Limitations
⚠️ **None** - Full historical coverage

### Usage for Modeling
✅ **All models** - No date restrictions

### Quality Notes
- Reanalysis data (modeled/interpolated, not raw observations)
- Temperature accuracy: ±1°C
- Precipitation accuracy: ±20%
- Some regions are approximate centroids of growing areas

### Region Details
See `research_agent/config/region_coordinates.json` for:
- Precise lat/lon coordinates for each region
- Elevation, commodity type, country
- Growing area descriptions

---

## Weather Forecasts (Forward-Looking)
**Databricks Tables**: `commodity.bronze.weather_forecast`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: **2015-07-07 to present**
- **Regions**: 67 coffee/sugar growing regions (same as weather actuals)
- **Frequency**: Daily forecasts
- **Horizon**: 16 days ahead (days 1-16)
- **Variables**: Temperature (min/max/mean), Precipitation, Humidity, Wind Speed

### Source
- **2015-2025**: Synthetic forecasts (generated from historical actuals + realistic error)
- **2025-11-06+**: Real forecasts from Open-Meteo Forecast API (free)

### ⚠️ CRITICAL LIMITATIONS - DATA LEAKAGE

**Synthetic Forecasts (2015-07-07 to 2025-11-05):**
- ⚠️ **HAS DATA LEAKAGE** - Generated by adding random error to actual weather
- Method: `forecast = actual_weather + random_error`
- The synthetic forecast "knows" the actual outcome (just adds noise)
- **May overestimate forecast utility** compared to real forecasts
- **All models using this data MUST document the data leakage**

**Real Forecasts (2025-11-06 onwards):**
- ✅ **NO DATA LEAKAGE** - Real forecasts from Open-Meteo
- True forward-looking predictions with no future information

### Why Synthetic Data is Used

**Purpose**: Proof-of-concept to evaluate whether weather forecasts improve SARIMAX models enough to justify purchasing real historical forecast data (~$195 from Visual Crossing).

**Strategy**:
1. Train models on synthetic forecasts (2015-2025) to test potential
2. If significant improvement → Consider purchasing real historical data
3. Transition to real forecasts only once enough real data accumulated (6+ months)

### Usage for Modeling

⚠️ **REQUIRED DOCUMENTATION**:
```python
# ANY model using synthetic forecast data MUST document this
"""
MODEL LIMITATION: This model uses synthetic weather forecasts (2015-2025)
which have DATA LEAKAGE. The forecasts were generated by adding realistic
error to actual weather data, meaning they "know" the actual outcome.

Results may OVERESTIMATE forecast utility compared to real forecasts.

See: research_agent/infrastructure/WEATHER_FORECAST_LIMITATION.md
"""
```

✅ **Allowed with documentation**:
```python
# Train model on full history (including synthetic forecasts)
train_start = pd.Timestamp('2015-07-07')
train_data = unified_data[unified_data['date'] >= train_start]

# BUT: Document that forecasts 2015-2025 are synthetic with data leakage
```

✅ **Preferred for production** (once enough real data available):
```python
# Train only on real forecasts (no data leakage)
train_start = pd.Timestamp('2025-11-06')
train_data = unified_data[unified_data['date'] >= train_start]
```

### Why This Matters
Weather **forecasts** (what was predicted) are fundamentally different from weather **actuals** (what happened). Using forecasts creates proper causality:

```
Correct:   Weather Forecast (T) → Price Forecast (T+14)
Incorrect: Weather Actual (T-14) → Price Forecast (T+14)
```

### Quality Notes
- Forecast accuracy degrades with horizon (day 1 > day 14)
- Temperature forecast error: ~2-3°C at day 14
- Precipitation forecast reliability: Moderate
- Best for capturing weather trends/patterns, not exact values

### Implementation Details
- **Lambda Function**: `weather-forecast-fetcher` (runs daily at 6 AM UTC)
- **Backfill**: Historical forecasts from Open-Meteo archive (2021+)
- **S3 Path**: `s3://commodity-data/weather-forecast/`
- **Deduplication**: Most recent forecast kept per (forecast_date, target_date, region)

---

## VIX Data (Volatility Index)
**Databricks Tables**: `commodity.bronze.vix`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Frequency**: Daily
- **Variable**: VIX close value

### Source
- CBOE Volatility Index via Yahoo Finance

### Limitations
⚠️ **None** - Full historical coverage

### Usage for Modeling
✅ **All models** - No date restrictions

### Quality Notes
- Market fear gauge (S&P 500 implied volatility)
- Useful for capturing macro uncertainty
- Indirect impact on commodity prices

---

## Macro Economic Data
**Databricks Tables**: `commodity.bronze.macro`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Frequency**: Daily (interpolated for non-trading days)
- **Variables**: Bond yields, exchange rates, inflation indicators

### Source
- FRED (Federal Reserve Economic Data)
- World Bank Open Data

### Limitations
⚠️ **Some indicators released monthly/quarterly** - daily data is forward-filled

### Usage for Modeling
✅ **All models** - Be aware of forward-fill for high-frequency models

### Quality Notes
- Macroeconomic data is typically lagged (reported after the fact)
- Daily interpolation may smooth over real volatility
- Best for capturing long-term trends

---

## CFTC Data (Commitment of Traders)
**Databricks Tables**: `commodity.bronze.cftc`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Frequency**: Weekly (released Tuesday, reflects Friday positions)
- **Variables**: Net long/short positions by trader category

### Source
- CFTC (Commodity Futures Trading Commission)

### Limitations
⚠️ **Weekly data only** - forward-filled for daily modeling
⚠️ **3-day lag** - Friday positions reported on Tuesday

### Usage for Modeling
✅ **All models** - Be aware of weekly granularity and lag

### Quality Notes
- Useful for sentiment/positioning analysis
- Net positions can signal overextension
- Forward-filling may not capture intra-week sentiment shifts

---

## GDELT Data (News Sentiment)
**Databricks Tables**: `commodity.bronze.gdelt`, `commodity.silver.unified_data`

### Coverage
- **Date Range**: 2015-07-07 to present
- **Frequency**: Daily
- **Variables**: News tone, event counts, sentiment scores

### Source
- GDELT Project (Global Database of Events, Language, and Tone)
- Query: Coffee/Sugar related news

### Limitations
⚠️ **Sentiment analysis is noisy** - may not directly correlate with prices
⚠️ **Language bias** - English news over-represented

### Usage for Modeling
✅ **All models** - Best combined with other features
⚠️ **Experimental** - Impact on forecast quality varies

### Quality Notes
- Captures global news sentiment
- Useful for detecting major events (weather disasters, policy changes)
- May lead or lag actual price movements

---

## Region Coordinates
**File**: `research_agent/config/region_coordinates.json`

### Coverage
- **Regions**: 67 coffee/sugar growing regions
- **Coordinates**: Precise lat/lon for agricultural zones (not country centroids)

### Variables
- `region`: Region name (matches weather data)
- `latitude`: Decimal degrees
- `longitude`: Decimal degrees
- `commodity`: Coffee or Sugar
- `elevation_m`: Elevation in meters
- `country`: Country name
- `description`: Growing area description

### Example
```json
{
  "region": "Antigua_Guatemala",
  "latitude": 14.5600,
  "longitude": -90.7347,
  "commodity": "Coffee",
  "elevation_m": 1500,
  "country": "Guatemala",
  "description": "Antigua coffee region, volcanic highlands"
}
```

### Usage
- Weather API calls use these coordinates
- Can be joined with unified_data for location-based features
- Elevation may be predictive for coffee quality/yield

### Quality Notes
- Coordinates represent approximate center of growing region
- Some regions are aggregated (e.g., "Country_Average")
- Verified against actual weather data regions (100% match)

---

## Unified Data Table
**Databricks Table**: `commodity.silver.unified_data`

This table joins all data sources by date and region.

### Schema
```sql
CREATE TABLE commodity.silver.unified_data (
  date DATE,
  commodity STRING,          -- Coffee or Sugar
  region STRING,             -- Growing region
  latitude DECIMAL(8,5),     -- Region latitude
  longitude DECIMAL(8,5),    -- Region longitude
  elevation_m INT,           -- Region elevation

  -- Market Data (no date restrictions)
  close DECIMAL(10,2),       -- Commodity closing price

  -- Weather Actuals (no date restrictions)
  temp_mean_c DECIMAL(5,2),  -- Actual mean temperature
  precipitation_mm DECIMAL(6,2),
  humidity_pct INT,

  -- Weather Forecasts (2021-01-01+ only)
  forecast_temp_mean_c DECIMAL(5,2),     -- 14-day ahead forecast
  forecast_precipitation_mm DECIMAL(6,2),
  forecast_humidity_pct DECIMAL(5,2),
  days_ahead INT,                         -- Always 14 for unified_data

  -- VIX (no date restrictions)
  vix DECIMAL(6,2),

  -- Other features...
) PARTITIONED BY (commodity, date);
```

### Data Availability Rules

| Feature | Start Date | Models Can Use |
|---------|-----------|----------------|
| Market prices | 2015-07-07 | All dates |
| Weather actuals | 2015-07-07 | All dates |
| **Weather forecasts** | **2021-01-01** | **2021+ only** ⚠️ |
| VIX | 2015-07-07 | All dates |
| Macro | 2015-07-07 | All dates |
| CFTC | 2015-07-07 | All dates |
| GDELT | 2015-07-07 | All dates |

### Training Models with Weather Forecasts

**Safe Training Window**:
```python
# Train on 2021+ data when using weather forecasts
df_filtered = unified_data[unified_data['date'] >= '2021-01-01']
```

**Why**: Weather forecasts are only available from 2021+. Training on earlier data would have null forecast values or require imputation, which would be artificial.

---

## Pipeline Architecture

```
┌─────────────────────────────────────────────────────────────┐
│ DATA SOURCES                                                 │
│  • Market Data API (2015+)                                   │
│  • Weather API (2015+)                                       │
│  • Weather Forecast API (2021+) ⚠️                           │
│  • VIX API (2015+)                                           │
│  • Macro APIs (2015+)                                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ LANDING (S3 → Databricks External Tables)                   │
│  • commodity.landing.*_inc                                   │
│  • Append-only, raw data with ingest_ts                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ BRONZE (Deduplicated, Clean Column Names)                   │
│  • commodity.bronze.market                                   │
│  • commodity.bronze.weather                                  │
│  • commodity.bronze.weather_forecast (2021+) ⚠️              │
│  • commodity.bronze.vix                                      │
│  • commodity.bronze.macro                                    │
│  • commodity.bronze.cftc                                     │
│  • commodity.bronze.gdelt                                    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ SILVER (Business Logic, Joined)                             │
│  • commodity.silver.unified_data                             │
│    → All sources joined by date + region                     │
│    → Weather forecasts included (2021+) ⚠️                   │
│    → Ready for modeling                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ FORECAST (Model Outputs)                                     │
│  • commodity.forecast.point_forecasts                        │
│  • commodity.forecast.distributions                          │
│  • commodity.forecast.forecast_metadata                      │
└─────────────────────────────────────────────────────────────┘
```

---

## Quick Reference: Model Training Guidelines

### When Training WITHOUT Weather Forecasts
✅ Use full history: `2015-07-07` onwards
```python
train_data = unified_data[unified_data['date'] >= '2015-07-07']
features = ['close', 'temp_mean_c', 'vix', 'macro_*']  # No forecast features
```

### When Training WITH Weather Forecasts
⚠️ Use 2021+ only: `2021-01-01` onwards
```python
train_data = unified_data[unified_data['date'] >= '2021-01-01']
features = ['close', 'temp_mean_c', 'forecast_temp_mean_c', 'vix', 'macro_*']
```

### Feature Engineering Best Practices
```python
# Good: Calculate forecast error (2021+ only)
df['temp_forecast_error'] = df['temp_mean_c'] - df['forecast_temp_mean_c']

# Good: Use forecast as exogenous variable in SARIMAX (2021+ only)
exog = df[['forecast_temp_mean_c', 'forecast_precipitation_mm']]

# Bad: Mixing forecast features with pre-2021 data
# This will have nulls or require questionable imputation
```

---

## Maintenance and Updates

### Daily Updates
- All data sources refresh daily via Lambda functions (6 AM UTC)
- Weather forecasts: New 16-day forecast fetched daily
- Market data: Previous day's closing prices

### Quality Monitoring
- Data freshness checks (alerts if > 2 days old)
- Missing region checks
- Duplicate detection

### Documentation Updates
When adding new data sources:
1. Update this file (DATA_SOURCES.md)
2. Update table COMMENTs in Databricks
3. Update unified_data schema documentation
4. Note any date limitations clearly

---

**Last Updated**: 2025-11-05
**Maintained By**: Research Agent Team
**Questions**: See `research_agent/README.md` for architecture overview
